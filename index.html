<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Selbsterkenntnis | Bullenpower</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lora:ital@1&display=swap');
        body { background-color: #050505; color: #d4af37; font-family: 'Cinzel', serif; overflow: hidden; }
        .page { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; position: absolute; width: 100%; transition: opacity 0.8s ease-in-out; padding: 20px; text-align: center; }
        .hidden { opacity: 0; pointer-events: none; }
        input { background: transparent; border-bottom: 1px solid #333; outline: none; padding: 10px; width: 100%; max-width: 400px; color: #fff; font-family: 'Lora', serif; font-style: italic; font-size: 1.5rem; text-align: center; transition: border-color 0.5s; }
        input:focus { border-color: #d4af37; }
        .gold-glow { text-shadow: 0 0 20px rgba(212, 175, 55, 0.5); }
        .list-item { border-bottom: 1px solid rgba(212, 175, 55, 0.1); padding: 10px; font-family: 'Lora', serif; font-size: 0.9rem; }
    </style>
</head>
<body>

    <div id="survey-container">
        </div>

    <div id="final-page" class="page hidden">
        <h2 class="gold-glow text-2xl mb-4">Danke für deine Zeit.</h2>
        <p class="font-serif italic text-gray-500 mb-10">Ich hoffe, du hast dich jetzt besser kennengelernt. Ich auf jeden Fall ;)</p>
        
        <div class="w-full max-w-md bg-stone-900/30 border border-gold/10 rounded-lg p-6">
            <h3 class="text-xs tracking-widest uppercase mb-4 opacity-50">Letzte Seelenforscher:</h3>
            <div id="live-list" class="max-h-60 overflow-y-auto">
                <p class="text-xs italic opacity-30">Lade Liste...</p>
            </div>
        </div>
    </div>

    <script>
        // KONFIGURATION
        const FORMSPREE_URL = "https://formspree.io/f/DEINE_ID"; // Dein Webhook für die Antworten
        const SUPABASE_URL = 'https://sscbgmurgndibyewluox.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_JxrdID7HqDC6lZ1Ze44V4Q_t9jweUAY';
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const fragen = [
            "Wer bist du?", "Wer bist du wirklich?", "Wer willst du sein?", "Wer willst du einmal werden?",
            "Wer wolltest du immer werden?", "Wohin wolltest du schon immer?", "Gefällt es dir, wo du bist?",
            "Wo wärst du am liebsten jetzt?", "Bist du hungrig?", "Was möchtest du jetzt essen?",
            "Warum wartest du auf den ersten Schritt deines Gegenübers?", "Hast du schon einmal etwas gestohlen?",
            "Hast du jemals Drogen konsumiert?", "Hast du schon mal jemand betrogen?", "Bist du ehrlich?",
            "Ist heute schönes Wetter?", "Welches Auto fährst du?", "Wann hast du Feierabend?",
            "Bist du sportlich?", "Hattest du schon mal Angst?", "Vor was denn?",
            "War das Warum der gleiche Grund wie das wovon?", "Welche ist deine Lieblingsfarbe?",
            "Warum?", "Welches ist dein Lieblingsessen?", "Warum?"
        ];

        let currentStep = 0;
        let answers = {};
        let startTime = Date.now();

        function initSurvey() {
            const container = document.getElementById('survey-container');
            fragen.forEach((q, i) => {
                const div = document.createElement('div');
                div.id = `step-${i}`;
                div.className = `page ${i === 0 ? '' : 'hidden'}`;
                div.innerHTML = `
                    <p class="text-gray-600 text-xs mb-4 uppercase tracking-[0.3em]">Frage ${i + 1} von ${fragen.length}</p>
                    <h2 class="gold-glow text-3xl md:text-4xl mb-12">${q}</h2>
                    <input type="text" id="ans-${i}" onkeypress="handleKey(event, ${i})" autocomplete="off">
                    <button onclick="nextStep(${i})" class="mt-12 text-[10px] tracking-widest opacity-30 hover:opacity-100 transition">DRÜCKE ENTER</button>
                `;
                container.appendChild(div);
            });
        }

        function handleKey(e, i) { if(e.key === "Enter") nextStep(i); }

        async function nextStep(i) {
            const val = document.getElementById(`ans-${i}`).value;
            answers[`q${i+1}_${fragen[i].substring(0,20)}`] = val;

            document.getElementById(`step-${i}`).classList.add('hidden');
            
            if(i + 1 < fragen.length) {
                document.getElementById(`step-${i+1}`).classList.remove('hidden');
            } else {
                finishSurvey();
            }
        }

        async function finishSurvey() {
            const endTime = Date.now();
            const durationSeconds = Math.floor((endTime - startTime) / 1000);
            const userName = answers["q1_Wer bist du?"] || "Anonym";

            // 1. Unbemerkt an Formspree senden
            fetch(FORMSPREE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...answers, dauer_sekunden: durationSeconds })
            });

            // 2. In Live-Liste (Supabase) speichern
            await supabase.from('survey_results').insert([
                { name: userName, duration: durationSeconds }
            ]);

            // 3. Finale Seite anzeigen & Liste laden
            document.getElementById('final-page').classList.remove('hidden');
            loadLiveList();

            // 4. Redirect nach 8 Sekunden (damit man die Liste kurz sieht)
            setTimeout(() => {
                window.location.href = "https://www.bullenpower-uri.ch";
            }, 8000);
        }

        async function loadLiveList() {
            const { data } = await supabase.from('survey_results').select('*').order('created_at', { ascending: false }).limit(5);
            const listDiv = document.getElementById('live-list');
            listDiv.innerHTML = data.map(entry => `
                <div class="list-item flex justify-between">
                    <span>${entry.name}</span>
                    <span class="opacity-40">${entry.duration} Sek.</span>
                </div>
            `).join('');
        }

        initSurvey();
    </script>
</body>
</html>
